<!DOCTYPE html>
<html>
  <head>
    <style>
      #app {
        display: flex;
        justify-content: center;
        align-items: flex-end;
      }

      #revoluciones-contenedor,
      #velocidad-contenedor {
        width: 100px;
        height: 300px;
        background-color: #f0f0f0;
      }

      .grafica {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        font-size: 2em;
        font-weight: bold;
      }
      
      .barra {
        width: 50px;
        height: 1%;
        background-color: #000;
        transition: height 0.2s;
      }
    </style>
  </head>
<body>
  <div id="app">
    <div id="revoluciones-contenedor">
      <div class="grafica">
        <div class="barra" style="height:0%"></div>
      </div>
      
      <div class="contador">0</div>
    </div>

    <div id="velocidad-contenedor">
      <div class="grafica">
        <div class="barra" style="height:0%"></div>
      </div>
      
      <div class="contador">0</div>
    </div>

    <div id="marcha-contenedor">
      <div class="contador">1</div>
    </div>
  </div>

  <script>
    // Crearemos un contador de revoluciones similar al de un auto
    // creamos una variable global para almacenar nuestros datos
    window.TableroDelAuto = {
      maximoRevoluciones: 8000,
      velocidadMaxima: 250,
      revoluciones: 1,
      velocidad: 1,
      marcha: 1,
      circunferenciaRueda: 0.61 * Math.PI, // 0.61 metros de diametro
      relacionDiferencialFinal: 4,
      ratiosDeMarcha: {
        1: 3.5,
        2: 2.0,
        3: 1.5,
        4: 1.0,
        5: 0.8
      },
      umbralesDeRevolucionesPorMarcha: {
        1: { min: 0, max: 3000 },
        2: { min: 2000, max: 3500 },
        3: { min: 2500, max: 4000 },
        4: { min: 3000, max: 4500 },
        5: { min: 3500, max: 8000 },
      },
      acelerador: {
        presionado: false,
        bloqueo: false,
        bloquear: function() {
          this.bloqueo = true;
        },
        desbloquear: function() {
          this.bloqueo = false;
        },
        presionar: function() {
          if (this.bloqueo) return;
          this.presionado = true
        },
        soltar: function() {
          this.presionado = false
        }
      }
    };

    // creamos una función que se encargará de actualizar el valor de las revoluciones
    function actualizarRevoluciones() {
      if (window.TableroDelAuto.revoluciones > window.TableroDelAuto.maximoRevoluciones) {
        window.TableroDelAuto.revoluciones = window.TableroDelAuto.maximoRevoluciones;
      } else if (window.TableroDelAuto.revoluciones < 0) {
        window.TableroDelAuto.revoluciones = 0;
      }
      
      // actualizamos la grafica
      actualizarGrafica('revoluciones-contenedor', window.TableroDelAuto.revoluciones, window.TableroDelAuto.maximoRevoluciones);
    }

    // creamos una función que se encargará de actualizar la velocidad
    function actualizarVelocidad() {
      // actualizamos la velocidad
      window.TableroDelAuto.velocidad = (
        (window.TableroDelAuto.revoluciones * window.TableroDelAuto.circunferenciaRueda) / 
        (
          window.TableroDelAuto.ratiosDeMarcha[window.TableroDelAuto.marcha.toString()] * 
          window.TableroDelAuto.relacionDiferencialFinal)
        ) * 
        (60 / 1000);
      // actualizamos la grafica
      actualizarGrafica('velocidad-contenedor', window.TableroDelAuto.velocidad, window.TableroDelAuto.velocidadMaxima);
    }

    // creamos una función que se encargará de subir una marcha
    function subirMarcha() {
      if (window.TableroDelAuto.marcha < 6) {
        window.TableroDelAuto.marcha++;

        // reducimos las revoluciones al minimo del umbral de marcha
        window.TableroDelAuto.revoluciones = window.TableroDelAuto.umbralesDeRevolucionesPorMarcha[window.TableroDelAuto.marcha].min;
      }
    }

    // creamos una función que se encargará de bajar una marcha
    function bajarMarcha() {
      if (window.TableroDelAuto.marcha > 1) {
        window.TableroDelAuto.marcha--;

        // aumentamos las revoluciones al maximo del umbral de marcha
        window.TableroDelAuto.revoluciones = window.TableroDelAuto.umbralesDeRevolucionesPorMarcha[window.TableroDelAuto.marcha].max;
      }
    }

    // creamos una función que se encargará de cambiar la marcha si hay q subirla o bajarla
    function determinarMarcha() {
      // si las revoluciones son mayores al umbral de la marcha actual
      if (window.TableroDelAuto.revoluciones > window.TableroDelAuto.umbralesDeRevolucionesPorMarcha[window.TableroDelAuto.marcha].max) {
        // subimos la marcha
        subirMarcha();
        actualizarMarcha();
      } else if (window.TableroDelAuto.revoluciones < window.TableroDelAuto.umbralesDeRevolucionesPorMarcha[window.TableroDelAuto.marcha].min) {
        // bajamos la marcha
        bajarMarcha();
        actualizarMarcha();
      }
    }

    // creamos una funcion para actualizar la marcha
    function actualizarMarcha() {
      // actualizamos la marcha
      document.getElementById('marcha-contenedor').querySelector('.contador').innerText = window.TableroDelAuto.marcha;
    }

    // creamos una función que se encargará de aumentar las revoluciones
    function aumentarRevoluciones() {
      // aumentamos las revoluciones
      if (window.TableroDelAuto.revoluciones < window.TableroDelAuto.maximoRevoluciones) {
        // aumentamos las revoluciones en 100
        window.TableroDelAuto.revoluciones += 150;
        determinarMarcha();

        // actualizamos el valor de las revoluciones
        actualizarRevoluciones();
        actualizarVelocidad();
      }
    }

    // creamos una función que se encargará de disminuir las revoluciones
    function disminuirRevoluciones() {
      // disminuimos las revoluciones
      if (window.TableroDelAuto.revoluciones > 0) {
        window.TableroDelAuto.revoluciones -= 150;
        determinarMarcha();

        // actualizamos el valor de las revoluciones
        actualizarRevoluciones();
        actualizarVelocidad();
      }
    }

    // creamos los eventos para presionar y soltar el acelerador
    window.addEventListener('keydown', function(event) {
      if (event.key === 'ArrowUp') {
        window.TableroDelAuto.acelerador.presionar();
      }
    });

    window.addEventListener('keyup', function(event) {
      if (event.key === 'ArrowUp') {
        window.TableroDelAuto.acelerador.soltar();
      }
    });

    // creamos un evento tick, este es un patron muy utilizado en videojuegos
    // para actualizar el estado del juego. Nos tenemos que asegurar de que
    // si las teclas que esperamos estan presionadas, se ejecute la acción
    // correspondiente. Es importante saber que este evento se ejecuta cada
    // 200 milisegundos.
    function tick() {
      // si el acelerador está presionado, aumentamos las revoluciones
      if (window.TableroDelAuto.acelerador.presionado) {
        aumentarRevoluciones();
      } else {
        // si el acelerador no está presionado, disminuimos las revoluciones
        disminuirRevoluciones();
      }
    }

    // creamos un intervalo que se encargará de ejecutar el evento tick cada 200 milisegundos
    setInterval(tick, 50);

    // Refactor:
    function actualizarGrafica(contenedor, valor, maximo) {
      // obtenemos el elemento que contiene las revoluciones
      const grafica = document.getElementById(contenedor);
      grafica.querySelector('.contador').innerText = valor;
      grafica.querySelector('.grafica .barra').style.height = `${parseInt(valor * 100 / maximo)}%`;
    }
  </script>
</body>
</html>